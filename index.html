<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados Loteca</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0066b3',
                        'primary-light': '#1976d2',
                        'primary-dark': '#004c8c',
                        secondary: '#f81a03',
                        'secondary-light': '#ff4433',
                        'secondary-dark': '#d50000',
                        tertiary: '#f9fbfa',
                        'light-bg': '#f9fbfa',
                        'dark-bg': '#001a2e',
                        'custom-100': '#ffffff',
                        'custom-95': '#f9fbfa',
                        'custom-90': '#f3f7fa',
                        'custom-85': '#edf3f9',
                        'custom-80': '#e7eff8',
                        'custom-75': '#e1ebf7',
                        'custom-70': '#dbe7f6',
                        'custom-65': '#d5e3f5',
                        'custom-60': '#cfdef4',
                        'custom-55': '#c9daf3',
                        'custom-50': '#c3d6f2',
                        'custom-45': '#b7cef0',
                        'custom-40': '#abc6ee',
                        'custom-35': '#9fbeec',
                        'custom-30': '#93b6ea',
                        'custom-29': '#0066b3',
                        'custom-25': '#004c8c',
                        'custom-20': '#003d70',
                        'custom-15': '#002e54',
                        'custom-10': '#001a2e',
                        'custom-5': '#000d17',
                        'custom-0': '#000000'
                    }
                }
            }
        }
    </script>
    <style>
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .resultado-1 {
            background: linear-gradient(135deg, #0066b3, #1976d2);
            color: white;
            border-radius: 6px;
            font-weight: 700;
            padding: 6px 12px;
            font-size: 14px;
            text-align: center;
        }
        
        .resultado-x {
            background: linear-gradient(135deg, #6b7280, #9ca3af);
            color: white;
            border-radius: 6px;
            font-weight: 700;
            padding: 6px 12px;
            font-size: 14px;
            text-align: center;
        }
        
        .resultado-2 {
            background: linear-gradient(135deg, #f81a03, #ff4433);
            color: white;
            border-radius: 6px;
            font-weight: 700;
            padding: 6px 12px;
            font-size: 14px;
            text-align: center;
        }
        
        .placar-badge {
            background: linear-gradient(45deg, #f9fbfa, #edf3f9);
            color: #0066b3;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 16px;
            border: 2px solid #0066b3;
            font-family: 'Arial Black', sans-serif;
        }
        
        .equipe-casa {
            background: linear-gradient(135deg, #e7eff8, #f9fbfa);
            color: #004c8c;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #0066b3;
        }
        
        .equipe-visitante {
            background: linear-gradient(135deg, #fee2e2, #fef2f2);
            color: #dc2626;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #f81a03;
        }
        
        .jogo-badge {
            background: linear-gradient(45deg, #0066b3, #f81a03);
            color: white;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body class="bg-light-bg dark:bg-dark-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">
                ‚öΩ Resultados Loteca
            </h1>
            <p class="text-gray-600 dark:text-gray-300">
                Progn√≥sticos Esportivos - Caixa Econ√¥mica Federal
            </p>
        </div>

        <!-- Controles -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
            <div class="flex flex-col gap-4">
                <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
                    <div class="flex flex-col sm:flex-row gap-4 items-center">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">
                            Concursos:
                        </label>
                        <input 
                            type="number" 
                            id="concursoInicio" 
                            value="1"
                            placeholder="Concurso inicial"
                            class="px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white"
                        >
                        <span class="text-gray-500 dark:text-gray-400">at√©</span>
                        <input 
                            type="number" 
                            id="concursoFim" 
                            placeholder="Buscando √∫ltimo..."
                            class="px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white"
                        >
                    </div>
                    <button 
                        id="buscarBtn" 
                        class="bg-primary hover:bg-primary-dark text-white font-medium py-2 px-6 rounded-lg transition-colors duration-200 disabled:opacity-50"
                    >
                        üîç Carregar Resultados
                    </button>
                </div>
                
                <!-- Op√ß√µes de filtro e ordena√ß√£o -->
                <div class="flex flex-col sm:flex-row gap-4 items-center">
                    <label class="text-gray-700 dark:text-gray-300 font-medium">
                        Filtros:
                    </label>
                    
                    <select id="filtroResultado" class="px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <option value="">Todos os resultados</option>
                        <option value="1">Apenas vit√≥rias da casa (1)</option>
                        <option value="X">Apenas empates (X)</option>
                        <option value="2">Apenas vit√≥rias do visitante (2)</option>
                    </select>
                    
                    <input 
                        type="text" 
                        id="filtroEquipe" 
                        placeholder="Filtrar por equipe..."
                        class="px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white"
                    >
                    
                    <!-- Divisor -->
                    <div class="hidden sm:block w-px h-6 bg-gray-300 dark:bg-gray-600"></div>
                    
                    <label class="flex items-center">
                        <input type="checkbox" id="ordenarConcursoDecrescente" class="mr-2" checked>
                        <span class="text-gray-700 dark:text-gray-300">üî¢ Concursos em ordem decrescente</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden text-center py-8">
            <div class="loading bg-primary rounded-full w-12 h-12 mx-auto mb-4"></div>
            <p id="loadingText" class="text-gray-600 dark:text-gray-300 mb-4">Carregando resultados...</p>
            
            <!-- Barra de progresso -->
            <div class="max-w-md mx-auto">
                <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-2">
                    <div id="progressBar" class="bg-primary h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                    <span id="progressText">0 / 0 concursos</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>
            
            <!-- Bot√£o cancelar -->
            <button id="cancelarBtn" class="mt-4 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm transition-colors">
                ‚ùå Cancelar Carregamento
            </button>
        </div>

        <!-- Erro -->
        <div id="erro" class="hidden bg-red-100 dark:bg-red-900 border border-red-400 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg mb-6">
            <span id="erroMsg"></span>
        </div>

        <!-- Bot√£o Toggle Tabela -->
        <div id="toggleTabelaContainer" class="hidden mb-4 text-center">
            <button 
                id="toggleTabelaBtn" 
                class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-200"
            >
                üëÅÔ∏è Ocultar Tabela de Resultados
            </button>
        </div>

        <!-- Tabela de Resultados -->
        <div id="resultados" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                <div class="text-white p-4" style="background: linear-gradient(to right, #0066b3, #f81a03);">
                    <h2 class="text-xl font-bold text-center">LOTECA - PROGN√ìSTICOS ESPORTIVOS</h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Concurso
                                </th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Data Apura√ß√£o
                                </th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Jogos do Concurso
                                </th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                    Estat√≠sticas
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tabelaBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Resultados ser√£o inseridos aqui -->
                        </tbody>
                    </table>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3">
                    <div class="flex flex-col sm:flex-row justify-between items-center">
                        <p class="text-sm text-gray-600 dark:text-gray-300">
                            üìä Fonte: Caixa Econ√¥mica Federal - API Oficial
                        </p>
                        <p id="contadorResultados" class="text-sm font-medium text-primary-dark dark:text-primary-light">
                            <!-- Contador ser√° inserido aqui -->
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumo Estat√≠stico -->
        <div id="resumoEstatistico" class="hidden mt-8 rounded-lg p-6" style="background: linear-gradient(to right, #f9fbfa, #f3f7fa); border: 1px solid #c9daf3;">
            <h3 class="text-xl font-bold mb-6 text-center" style="color: #004c8c;">
                üìä Resumo Estat√≠stico da Loteca
            </h3>
            <div id="estatisticasGerais" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Estat√≠sticas ser√£o inseridas aqui -->
            </div>
            
            <!-- Gr√°fico de Resultados -->
            <div class="mt-6 p-4 bg-white dark:bg-gray-800 rounded-lg">
                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3 text-center">
                    üéØ Distribui√ß√£o de Resultados
                </h4>
                <div id="graficoResultados" class="space-y-3">
                    <!-- Gr√°fico ser√° inserido aqui -->
                </div>
            </div>
            
            <!-- Estat√≠sticas por Equipes -->
            <div id="estatisticasEquipes" class="mt-6 p-4 bg-white dark:bg-gray-800 rounded-lg">
                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3 text-center">
                    üèÜ Equipes Mais Frequentes
                </h4>
                <div id="dadosEquipes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Dados das equipes ser√£o inseridos aqui -->
                </div>
            </div>

            <!-- An√°lise por Estados -->
            <div class="mt-6 p-4 rounded-lg" style="background: linear-gradient(to bottom right, #f3f7fa, #e7eff8); border: 1px solid #c9daf3;">
                <h4 class="text-lg font-semibold mb-3 text-center" style="color: #004c8c;">
                    üìä An√°lise por Estados
                </h4>
                
                <!-- Controle de jogos a analisar -->
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-4">
                    <label class="text-sm font-medium" style="color: #003d70;">
                        Analisar √∫ltimos:
                    </label>
                    <input 
                        type="number" 
                        id="jogosAnalisar" 
                        value="20"
                        min="1"
                        max="100"
                        placeholder="N¬∫ de concursos"
                        class="px-3 py-2 text-base border rounded-lg focus:ring-2 dark:bg-gray-700 dark:text-white w-24"
                        style="border-color: #c9daf3; --tw-ring-color: #0066b3;"
                    >
                    <span class="text-sm" style="color: #003d70;">concursos mais recentes</span>
                    <button 
                        id="atualizarAnalise" 
                        class="text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200 text-sm"
                        style="background-color: #0066b3;"
                        onmouseover="this.style.backgroundColor='#004c8c'"
                        onmouseout="this.style.backgroundColor='#0066b3'"
                    >
                        üîÑ Atualizar
                    </button>
                </div>
                
                <!-- An√°lise por estados -->
                <div id="analiseEstados" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- An√°lise ser√° inserida aqui -->
                </div>
            </div>

            <!-- Estat√≠sticas de Mandos -->
            <div id="estatisticasMandos" class="mt-6 p-4 rounded-lg" style="background: linear-gradient(45deg, #f9fbfa, #fee2e2); color: #0066b3;">
                <h4 class="text-lg font-semibold mb-3 text-center" style="color: #004c8c;">
                    üèüÔ∏è Estat√≠sticas por Mando de Campo
                </h4>
                <div id="dadosMandos" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Dados de mandos ser√£o inseridos aqui -->
                </div>
            </div>

            <!-- Padr√µes encontrados -->
            <div class="mt-6 p-4 bg-white dark:bg-gray-800 rounded-lg">
                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3 text-center">
                    üîç Padr√µes Identificados
                </h4>
                <div id="padroes" class="text-sm text-gray-700 dark:text-gray-300">
                    <!-- Padr√µes ser√£o inseridos aqui -->
                </div>
            </div>
        </div>

        <!-- Informa√ß√µes Adicionais -->
        <div id="infoAdicional" class="hidden mt-8 bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-4">
                üìã Informa√ß√µes do Concurso
            </h3>
            <div id="detalhes" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-700 dark:text-blue-300">
                <!-- Detalhes ser√£o inseridos aqui -->
            </div>
        </div>
    </div>

    <script>
        // Detectar tema escuro
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Elementos do DOM
        const concursoInicio = document.getElementById('concursoInicio');
        const concursoFim = document.getElementById('concursoFim');
        const buscarBtn = document.getElementById('buscarBtn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressPercent = document.getElementById('progressPercent');
        const cancelarBtn = document.getElementById('cancelarBtn');
        const erro = document.getElementById('erro');
        const erroMsg = document.getElementById('erroMsg');
        const resultados = document.getElementById('resultados');
        const tabelaBody = document.getElementById('tabelaBody');
        const infoAdicional = document.getElementById('infoAdicional');
        const detalhes = document.getElementById('detalhes');
        const ordenarConcursoDecrescente = document.getElementById('ordenarConcursoDecrescente');
        const filtroResultado = document.getElementById('filtroResultado');
        const filtroEquipe = document.getElementById('filtroEquipe');

        // Vari√°veis globais
        let todosResultados = [];
        let carregamentoAtivo = false;
        let ultimoConcursoNumero = 0;

        // Fun√ß√£o para formatar data
        function formatarData(dataStr) {
            if (!dataStr) return 'N/A';
            
            try {
                let data;
                
                if (dataStr instanceof Date) {
                    data = dataStr;
                } else if (typeof dataStr === 'string') {
                    if (dataStr.includes('/')) {
                        const [dia, mes, ano] = dataStr.split('/');
                        data = new Date(ano, mes - 1, dia);
                    } else if (dataStr.includes('-')) {
                        data = new Date(dataStr);
                    } else if (dataStr.length === 8 && !isNaN(dataStr)) {
                        const dia = dataStr.substr(0, 2);
                        const mes = dataStr.substr(2, 2);
                        const ano = dataStr.substr(4, 4);
                        data = new Date(ano, mes - 1, dia);
                    } else if (!isNaN(dataStr)) {
                        data = new Date(parseInt(dataStr));
                    } else {
                        data = new Date(dataStr);
                    }
                } else {
                    data = new Date(dataStr);
                }
                
                if (data && !isNaN(data.getTime())) {
                    return data.toLocaleDateString('pt-BR');
                } else {
                    return 'N/A';
                }
            } catch (error) {
                console.error('Erro ao formatar data:', dataStr, error);
                return 'N/A';
            }
        }

        // Fun√ß√£o para determinar o resultado do jogo
        function determinarResultado(golsCasa, golsVisitante) {
            if (golsCasa > golsVisitante) return '1';
            if (golsCasa < golsVisitante) return '2';
            return 'X';
        }

        // Fun√ß√£o para buscar √∫ltimo concurso
        async function buscarUltimoConcurso() {
            try {
                console.log('Tentando buscar √∫ltimo concurso da Loteca...');
                const response = await fetch('https://servicebus2.caixa.gov.br/portaldeloterias/api/loteca');
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Dados recebidos da API:', data);
                
                if (!data || typeof data.numero === 'undefined') {
                    throw new Error('Resposta da API n√£o cont√©m n√∫mero do concurso');
                }
                
                const ultimoConcurso = data.numero;
                console.log('√öltimo concurso encontrado:', ultimoConcurso);
                return ultimoConcurso;
                
            } catch (error) {
                console.error('Erro detalhado ao buscar √∫ltimo concurso:', error);
                
                // Fallback: usar √∫ltimo concurso conhecido da Loteca (1200)
                const ultimoConhecido = 1200;
                
                console.log(`Usando fallback: √∫ltimo concurso conhecido ${ultimoConhecido}`);
                return ultimoConhecido;
            }
        }

        // Fun√ß√£o para atualizar progresso
        function atualizarProgresso(atual, total) {
            const porcentagem = Math.round((atual / total) * 100);
            progressBar.style.width = `${porcentagem}%`;
            progressText.textContent = `${atual} / ${total} concursos`;
            progressPercent.textContent = `${porcentagem}%`;
        }

        // Fun√ß√£o para cancelar carregamento
        function cancelarCarregamento() {
            carregamentoAtivo = false;
            loading.classList.add('hidden');
            buscarBtn.disabled = false;
            loadingText.textContent = 'Carregamento cancelado';
        }

        // Fun√ß√£o para buscar resultados de m√∫ltiplos concursos
        async function buscarResultados() {
            const inicio = parseInt(concursoInicio.value) || 1;
            let fim = parseInt(concursoFim.value);

            // Mostrar loading
            loading.classList.remove('hidden');
            resultados.classList.add('hidden');
            erro.classList.add('hidden');
            infoAdicional.classList.add('hidden');
            buscarBtn.disabled = true;
            carregamentoAtivo = true;

            try {
                // Se n√£o especificou fim, buscar √∫ltimo concurso
                if (!fim) {
                    loadingText.textContent = 'Buscando √∫ltimo concurso...';
                    fim = await buscarUltimoConcurso();
                    if (!fim) throw new Error('N√£o foi poss√≠vel determinar o √∫ltimo concurso');
                    ultimoConcursoNumero = fim;
                    concursoFim.value = fim;
                }

                // Valida√ß√µes
                if (inicio > fim) {
                    throw new Error('Concurso inicial n√£o pode ser maior que o final');
                }

                const totalConcursos = fim - inicio + 1;
                const tamanhoBatch = 10;
                let concursosCarregados = 0;

                loadingText.textContent = `Carregando ${totalConcursos} concursos em lotes...`;
                atualizarProgresso(0, totalConcursos);

                todosResultados = [];

                // Carregar em lotes com retry
                for (let i = inicio; i <= fim && carregamentoAtivo; i += tamanhoBatch) {
                    const fimBatch = Math.min(i + tamanhoBatch - 1, fim);
                    
                    const promisesBatch = [];
                    for (let j = i; j <= fimBatch; j++) {
                        promisesBatch.push(buscarConcursoComRetry(j));
                    }

                    const resultadosBatch = await Promise.allSettled(promisesBatch);
                    
                    resultadosBatch.forEach((resultado, index) => {
                        if (resultado.status === 'fulfilled' && resultado.value) {
                            todosResultados.push(resultado.value);
                        }
                        concursosCarregados++;
                        
                        atualizarProgresso(concursosCarregados, totalConcursos);
                    });

                    if (todosResultados.length > 0) {
                        todosResultados.sort((a, b) => a.numero - b.numero);
                        exibirTodosResultados();
                    }

                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                if (!carregamentoAtivo) {
                    throw new Error('Carregamento cancelado pelo usu√°rio');
                }

                todosResultados.sort((a, b) => a.numero - b.numero);

                if (todosResultados.length === 0) {
                    throw new Error('Nenhum resultado encontrado na API. Tente novamente.');
                }

                loadingText.textContent = `‚úÖ Carregados ${todosResultados.length} concursos com sucesso!`;
                exibirTodosResultados();
                gerarResumoEstatistico();
                
            } catch (error) {
                console.error('Erro ao buscar resultados:', error);
                erroMsg.textContent = error.message;
                erro.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                buscarBtn.disabled = false;
                carregamentoAtivo = false;
            }
        }

        // Fun√ß√£o para carregar TODOS os concursos automaticamente
        async function carregarTodosOsConcursos() {
            loadingText.textContent = 'Iniciando carregamento de TODOS os concursos da Loteca...';
            
            try {
                const ultimoConcurso = await buscarUltimoConcurso();
                if (!ultimoConcurso) {
                    throw new Error('N√£o foi poss√≠vel determinar o √∫ltimo concurso');
                }

                ultimoConcursoNumero = ultimoConcurso;
                
                concursoInicio.value = 1;
                concursoFim.value = ultimoConcurso;
                
                await buscarResultados();
                
            } catch (error) {
                console.error('Erro ao carregar todos os concursos:', error);
                erroMsg.textContent = `Erro ao carregar todos os concursos: ${error.message}`;
                erro.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        }

        // Fun√ß√£o para buscar um concurso com retry
        async function buscarConcursoComRetry(numero, tentativas = 3) {
            for (let i = 0; i < tentativas; i++) {
                try {
                    const response = await fetch(`https://servicebus2.caixa.gov.br/portaldeloterias/api/loteca/${numero}`, {
                        timeout: 10000
                    });
                    if (!response.ok) {
                        if (i === tentativas - 1) return null;
                        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                        continue;
                    }
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error(`Tentativa ${i + 1} falhou para concurso ${numero}:`, error);
                    if (i === tentativas - 1) return null;
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
            return null;
        }

        // Fun√ß√£o para exibir todos os resultados na tabela
        function exibirTodosResultados() {
            tabelaBody.innerHTML = '';

            const resultadosParaExibir = [...todosResultados].sort((a, b) => {
                if (ordenarConcursoDecrescente.checked) {
                    return b.numero - a.numero;
                } else {
                    return a.numero - b.numero;
                }
            });

            resultadosParaExibir.forEach(data => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                row.dataset.concurso = data.numero;

                // N√∫mero do concurso
                const cellConcurso = document.createElement('td');
                cellConcurso.className = 'px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white';
                cellConcurso.textContent = data.numero;
                row.appendChild(cellConcurso);

                // Data do sorteio
                const cellData = document.createElement('td');
                cellData.className = 'px-3 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300';
                
                const dataFormatada = formatarData(data.dataApuracao) || 
                                    formatarData(data.dataSorteio) || 
                                    formatarData(data.data) || 
                                    'N/A';
                                    
                cellData.textContent = dataFormatada;
                row.appendChild(cellData);

                // Jogos do concurso
                const cellJogos = document.createElement('td');
                cellJogos.className = 'px-3 py-3 text-xs';
                
                if (data.listaResultadoEquipeEsportiva && data.listaResultadoEquipeEsportiva.length > 0) {
                    let jogosHTML = '<div class="space-y-2 max-h-96 overflow-y-auto">';
                    
                    data.listaResultadoEquipeEsportiva
                        .sort((a, b) => a.nuSequencial - b.nuSequencial)
                        .forEach(jogo => {
                            const resultado = determinarResultado(jogo.nuGolEquipeUm, jogo.nuGolEquipeDois);
                            const resultadoClass = resultado === '1' ? 'resultado-1' : 
                                                 resultado === 'X' ? 'resultado-x' : 'resultado-2';
                            
                            jogosHTML += `
                                <div class="bg-gray-50 dark:bg-gray-700 p-2 rounded border">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="jogo-badge">${jogo.nuSequencial}¬∫</span>
                                        <span class="text-xs text-gray-500">${formatarData(jogo.dtJogo)} (${jogo.diaSemana})</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="equipe-casa text-xs">${jogo.nomeEquipeUm}</span>
                                        <span class="placar-badge mx-2">${jogo.nuGolEquipeUm} x ${jogo.nuGolEquipeDois}</span>
                                        <span class="equipe-visitante text-xs">${jogo.nomeEquipeDois}</span>
                                    </div>
                                    <div class="flex items-center justify-between mt-1">
                                        <span class="text-xs text-gray-500">${jogo.siglaUFUm}</span>
                                        <span class="${resultadoClass} text-xs">${resultado}</span>
                                        <span class="text-xs text-gray-500">${jogo.siglaUFDois}</span>
                                    </div>
                                </div>
                            `;
                        });
                    
                    jogosHTML += '</div>';
                    cellJogos.innerHTML = jogosHTML;
                } else {
                    cellJogos.textContent = 'Sem dados de jogos';
                }
                
                row.appendChild(cellJogos);

                // Estat√≠sticas do concurso
                const cellEstatisticas = document.createElement('td');
                cellEstatisticas.className = 'px-3 py-3 text-xs text-center';
                
                if (data.listaResultadoEquipeEsportiva && data.listaResultadoEquipeEsportiva.length > 0) {
                    let vitoriasCasa = 0, empates = 0, vitoriasVisitante = 0;
                    
                    data.listaResultadoEquipeEsportiva.forEach(jogo => {
                        const resultado = determinarResultado(jogo.nuGolEquipeUm, jogo.nuGolEquipeDois);
                        if (resultado === '1') vitoriasCasa++;
                        else if (resultado === 'X') empates++;
                        else vitoriasVisitante++;
                    });
                    
                    cellEstatisticas.innerHTML = `
                        <div class="space-y-1">
                            <div class="resultado-1 text-xs">1: ${vitoriasCasa}</div>
                            <div class="resultado-x text-xs">X: ${empates}</div>
                            <div class="resultado-2 text-xs">2: ${vitoriasVisitante}</div>
                        </div>
                    `;
                } else {
                    cellEstatisticas.textContent = 'N/A';
                }
                
                row.appendChild(cellEstatisticas);

                tabelaBody.appendChild(row);
            });

            resultados.classList.remove('hidden');
            document.getElementById('toggleTabelaContainer').classList.remove('hidden');
            aplicarFiltros();
        }

        // Fun√ß√£o para aplicar filtros
        function aplicarFiltros() {
            const filtroResultadoVal = filtroResultado.value.trim();
            const filtroEquipeVal = filtroEquipe.value.trim().toLowerCase();

            const rows = tabelaBody.querySelectorAll('tr');
            let resultadosVisiveis = 0;
            
            rows.forEach(row => {
                let mostrar = true;
                const concursoNum = row.dataset.concurso;
                const concursoData = todosResultados.find(r => r.numero == concursoNum);
                
                if (concursoData && concursoData.listaResultadoEquipeEsportiva) {
                    // Filtro por resultado
                    if (filtroResultadoVal) {
                        const temResultado = concursoData.listaResultadoEquipeEsportiva.some(jogo => {
                            const resultado = determinarResultado(jogo.nuGolEquipeUm, jogo.nuGolEquipeDois);
                            return resultado === filtroResultadoVal;
                        });
                        if (!temResultado) mostrar = false;
                    }
                    
                    // Filtro por equipe
                    if (filtroEquipeVal && mostrar) {
                        const temEquipe = concursoData.listaResultadoEquipeEsportiva.some(jogo => {
                            return jogo.nomeEquipeUm.toLowerCase().includes(filtroEquipeVal) ||
                                   jogo.nomeEquipeDois.toLowerCase().includes(filtroEquipeVal);
                        });
                        if (!temEquipe) mostrar = false;
                    }
                }

                row.style.display = mostrar ? '' : 'none';
                if (mostrar) {
                    resultadosVisiveis++;
                }
            });

            atualizarContador(resultadosVisiveis, todosResultados.length);
        }

        // Fun√ß√£o para atualizar contador de resultados
        function atualizarContador(visiveis, total) {
            const contador = document.getElementById('contadorResultados');
            if (visiveis === total) {
                contador.textContent = `üìä ${total} concursos carregados`;
            } else {
                contador.textContent = `üìä ${visiveis} de ${total} concursos (filtrado)`;
            }
        }

        // Event listeners
        buscarBtn.addEventListener('click', buscarResultados);
        cancelarBtn.addEventListener('click', cancelarCarregamento);
        
        // Event listeners para filtros
        filtroResultado.addEventListener('change', aplicarFiltros);
        filtroEquipe.addEventListener('input', aplicarFiltros);
        
        // Event listener para ordena√ß√£o decrescente dos concursos
        ordenarConcursoDecrescente.addEventListener('change', () => {
            if (todosResultados.length > 0) {
                exibirTodosResultados();
            }
        });

        // Enter nos campos de concurso
        concursoInicio.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') buscarResultados();
        });
        
        concursoFim.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') buscarResultados();
        });

        // Fun√ß√£o para calcular estat√≠sticas da Loteca
        function calcularEstatisticasLoteca() {
            const estatisticas = {
                resultados: { '1': 0, 'X': 0, '2': 0 },
                equipes: {},
                estados: {},
                totalJogos: 0,
                padroes: {}
            };

            todosResultados.forEach(resultado => {
                if (resultado.listaResultadoEquipeEsportiva) {
                    resultado.listaResultadoEquipeEsportiva.forEach(jogo => {
                        estatisticas.totalJogos++;
                        
                        // Contar resultados
                        const res = determinarResultado(jogo.nuGolEquipeUm, jogo.nuGolEquipeDois);
                        estatisticas.resultados[res]++;
                        
                        // Contar equipes
                        estatisticas.equipes[jogo.nomeEquipeUm] = (estatisticas.equipes[jogo.nomeEquipeUm] || 0) + 1;
                        estatisticas.equipes[jogo.nomeEquipeDois] = (estatisticas.equipes[jogo.nomeEquipeDois] || 0) + 1;
                        
                        // Contar estados
                        estatisticas.estados[jogo.siglaUFUm] = (estatisticas.estados[jogo.siglaUFUm] || 0) + 1;
                        estatisticas.estados[jogo.siglaUFDois] = (estatisticas.estados[jogo.siglaUFDois] || 0) + 1;
                    });
                }
            });

            return estatisticas;
        }

        // Fun√ß√£o para gerar resumo estat√≠stico
        function gerarResumoEstatistico() {
            if (todosResultados.length === 0) return;

            const resumoDiv = document.getElementById('resumoEstatistico');
            const estatisticasDiv = document.getElementById('estatisticasGerais');
            const graficoResultadosDiv = document.getElementById('graficoResultados');
            const dadosEquipes = document.getElementById('dadosEquipes');
            const dadosMandos = document.getElementById('dadosMandos');
            const padroesDiv = document.getElementById('padroes');

            const stats = calcularEstatisticasLoteca();
            const totalConcursos = todosResultados.length;

            // Cards estat√≠sticos principais
            estatisticasDiv.innerHTML = `
                <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-300">${totalConcursos}</div>
                    <div class="text-sm text-blue-800 dark:text-blue-200">Concursos</div>
                    <div class="text-sm font-semibold text-blue-800 dark:text-blue-200">Analisados</div>
                </div>
                <div class="p-4 rounded-lg text-center" style="background-color: #f3f7fa;">
                    <div class="text-2xl font-bold" style="color: #0066b3;">${stats.totalJogos}</div>
                    <div class="text-sm" style="color: #004c8c;">Jogos</div>
                    <div class="text-sm font-semibold" style="color: #004c8c;">Analisados</div>
                </div>
                <div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-red-600 dark:text-red-300">${Object.keys(stats.equipes).length}</div>
                    <div class="text-sm text-red-800 dark:text-red-200">Equipes</div>
                    <div class="text-sm font-semibold text-red-800 dark:text-red-200">Diferentes</div>
                </div>
                <div class="p-4 rounded-lg text-center" style="background-color: #edf3f9;">
                    <div class="text-2xl font-bold" style="color: #0066b3;">${Object.keys(stats.estados).length}</div>
                    <div class="text-sm" style="color: #004c8c;">Estados</div>
                    <div class="text-sm font-semibold" style="color: #004c8c;">Representados</div>
                </div>
            `;

            // Gr√°fico de resultados
            const maxValor = Math.max(stats.resultados['1'], stats.resultados['X'], stats.resultados['2']);
            graficoResultadosDiv.innerHTML = `
                <div class="flex items-center">
                    <div class="w-20 text-sm text-gray-600 dark:text-gray-400">Vit√≥rias Casa (1):</div>
                    <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-6 mx-3">
                        <div class="bg-blue-500 h-6 rounded-full flex items-center justify-end pr-2" style="width: ${(stats.resultados['1']/maxValor)*100}%">
                            <span class="text-xs text-white font-bold">${stats.resultados['1']}</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-20 text-sm text-gray-600 dark:text-gray-400">Empates (X):</div>
                    <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-6 mx-3">
                        <div class="bg-gray-500 h-6 rounded-full flex items-center justify-end pr-2" style="width: ${(stats.resultados['X']/maxValor)*100}%">
                            <span class="text-xs text-white font-bold">${stats.resultados['X']}</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="w-20 text-sm text-gray-600 dark:text-gray-400">Vit√≥rias Visit. (2):</div>
                    <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-6 mx-3">
                        <div class="bg-red-500 h-6 rounded-full flex items-center justify-end pr-2" style="width: ${(stats.resultados['2']/maxValor)*100}%">
                            <span class="text-xs text-white font-bold">${stats.resultados['2']}</span>
                        </div>
                    </div>
                </div>
            `;

            // Equipes mais frequentes
            const equipesOrdenadas = Object.entries(stats.equipes)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 12);

            let equipesHTML = '';
            equipesOrdenadas.forEach(([equipe, count]) => {
                const perc = ((count / stats.totalJogos) * 100).toFixed(1);
                equipesHTML += `
                    <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg text-center">
                        <div class="font-bold text-sm text-gray-800 dark:text-gray-200">${equipe}</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">${count} jogos</div>
                        <div class="text-xs text-gray-500 dark:text-gray-500">${perc}%</div>
                    </div>
                `;
            });
            dadosEquipes.innerHTML = equipesHTML;

            // Estat√≠sticas de mandos
            const percCasa = ((stats.resultados['1'] / stats.totalJogos) * 100).toFixed(1);
            const percEmpate = ((stats.resultados['X'] / stats.totalJogos) * 100).toFixed(1);
            const percVisitante = ((stats.resultados['2'] / stats.totalJogos) * 100).toFixed(1);
            
            dadosMandos.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg text-center">
                    <div class="resultado-1 mb-2 inline-block">CASA (1)</div>
                    <div class="text-2xl font-bold" style="color: #0066b3;">${stats.resultados['1']}</div>
                    <div class="text-sm" style="color: #004c8c;">${percCasa}%</div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg text-center">
                    <div class="resultado-x mb-2 inline-block">EMPATE (X)</div>
                    <div class="text-2xl font-bold text-gray-600">${stats.resultados['X']}</div>
                    <div class="text-sm text-gray-500">${percEmpate}%</div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg text-center">
                    <div class="resultado-2 mb-2 inline-block">VISITANTE (2)</div>
                    <div class="text-2xl font-bold" style="color: #f81a03;">${stats.resultados['2']}</div>
                    <div class="text-sm" style="color: #d50000;">${percVisitante}%</div>
                </div>
            `;

            // An√°lise por estados
            gerarAnaliseEstados();

            // Padr√µes e insights
            let insights = '';
            
            const resultadoMaisComum = Object.entries(stats.resultados)
                .sort(([,a], [,b]) => b - a)[0];
            
            if (resultadoMaisComum) {
                const nomeResultado = resultadoMaisComum[0] === '1' ? 'vit√≥rias da casa' : 
                                    resultadoMaisComum[0] === 'X' ? 'empates' : 'vit√≥rias do visitante';
                insights += `<p><strong>üéØ Resultado mais comum:</strong> ${nomeResultado} (${resultadoMaisComum[0]}) com ${resultadoMaisComum[1]} ocorr√™ncias.</p>`;
            }
            
            const equipeMaisFrequente = equipesOrdenadas[0];
            if (equipeMaisFrequente) {
                insights += `<p><strong>üèÜ Equipe mais frequente:</strong> ${equipeMaisFrequente[0]} participou de ${equipeMaisFrequente[1]} jogos.</p>`;
            }
            
            insights += `<p><strong>‚öΩ Especial Loteca:</strong> A Loteca √© baseada em progn√≥sticos de 14 jogos de futebol, onde voc√™ tenta acertar o resultado de cada partida.</p>`;
            
            padroesDiv.innerHTML = insights;

            resumoDiv.classList.remove('hidden');
        }

        // Fun√ß√£o para gerar an√°lise por estados
        function gerarAnaliseEstados(concursosAnalisar = 20) {
            const analiseEstadosDiv = document.getElementById('analiseEstados');
            
            if (todosResultados.length < concursosAnalisar) {
                analiseEstadosDiv.innerHTML = '<p class="text-center text-gray-500">Dados insuficientes para an√°lise</p>';
                return;
            }

            const ultimosConcursos = [...todosResultados]
                .sort((a, b) => b.numero - a.numero)
                .slice(0, concursosAnalisar);

            const estadosParticipacao = {};

            ultimosConcursos.forEach(concurso => {
                if (concurso.listaResultadoEquipeEsportiva) {
                    concurso.listaResultadoEquipeEsportiva.forEach(jogo => {
                        estadosParticipacao[jogo.siglaUFUm] = (estadosParticipacao[jogo.siglaUFUm] || 0) + 1;
                        estadosParticipacao[jogo.siglaUFDois] = (estadosParticipacao[jogo.siglaUFDois] || 0) + 1;
                    });
                }
            });

            const estadosOrdenados = Object.entries(estadosParticipacao)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 12);

            let estadosHTML = '';
            estadosOrdenados.forEach(([estado, count]) => {
                estadosHTML += `
                    <div class="bg-white dark:bg-gray-800 p-3 rounded-lg text-center border" style="border-color: #c9daf3;">
                        <div class="text-lg font-bold" style="color: #0066b3;">${estado}</div>
                        <div class="text-sm" style="color: #004c8c;">${count} jogos</div>
                    </div>
                `;
            });
            
            analiseEstadosDiv.innerHTML = estadosHTML;
        }

        // Event listeners para an√°lise
        document.getElementById('atualizarAnalise').addEventListener('click', () => {
            const concursos = parseInt(document.getElementById('jogosAnalisar').value) || 20;
            if (concursos < 1 || concursos > 100) {
                mostrarModal('Erro', 'Por favor, insira um valor entre 1 e 100 concursos.');
                return;
            }
            if (todosResultados.length < concursos) {
                mostrarModal('Dados Insuficientes', `N√£o h√° dados suficientes. Dispon√≠vel: ${todosResultados.length} concursos, Solicitado: ${concursos}`);
                return;
            }
            gerarAnaliseEstados(concursos);
        });

        // Enter no campo de jogos a analisar
        document.getElementById('jogosAnalisar').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('atualizarAnalise').click();
            }
        });

        // Fun√ß√£o para mostrar modal personalizada
        function mostrarModal(titulo, mensagem) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">${titulo}</h3>
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${mensagem}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded" onclick="this.closest('.fixed').remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Event listener para toggle da tabela
        document.getElementById('toggleTabelaBtn').addEventListener('click', () => {
            const resultados = document.getElementById('resultados');
            const toggleBtn = document.getElementById('toggleTabelaBtn');
            
            if (resultados.classList.contains('hidden')) {
                resultados.classList.remove('hidden');
                toggleBtn.textContent = 'üëÅÔ∏è Ocultar Tabela de Resultados';
                toggleBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-200';
            } else {
                resultados.classList.add('hidden');
                toggleBtn.textContent = 'üëÅÔ∏è Mostrar Tabela de Resultados';
                toggleBtn.className = 'bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-6 rounded-lg transition-colors duration-200';
            }
        });

        // üöÄ CARREGAR TODOS OS CONCURSOS AUTOMATICAMENTE AO ABRIR A APP
        document.addEventListener('DOMContentLoaded', async () => {
            carregarTodosOsConcursos();
        });
    </script>
</body>
</html>